<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>External Onboarding</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }
        .container {
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        h2 {
            margin-top: 0;
        }
        form {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 400px;
        }
        input {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
        }
        button {
            padding: 10px;
            background: #007BFF;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .hidden {
            display: none;
        }
        iframe, #step-3 {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
<div class="container">
    <div id="step-1">
        <h2>Create Borrower and Manager</h2>
        <form id="create-form">
            <input type="text" id="user-email" placeholder="User Email" required>
            <input type="text" id="user-name" placeholder="User Name" required>
            <input type="password" id="user-password" placeholder="User Password" required>
            <input type="text" id="company-name" placeholder="Company Name" required>
            <input type="text" id="address-line1" placeholder="Address Line 1" required>
            <input type="text" id="address-city" placeholder="City" required>
            <input type="text" id="address-region" placeholder="Region" required>
            <input type="text" id="address-postal-code" placeholder="Postal Code" required>
            <input type="text" id="address-country-code" placeholder="Country Code" required>
            <button type="submit" id="create-button">Create</button>
        </form>
    </div>

    <div id="step-2" class="hidden">
        <h2>Login</h2>
        <form id="login-form">
            <input type="text" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit" id="login-button">Login</button>
        </form>
    </div>

    <div id="step-3" class="hidden">
        <h2>Onboarding</h2>
        <iframe id="onboarding-iframe" src=""></iframe>
    </div>
</div>

<script>
  const API_KEY = 'change-this';
  const BACKEND_BASE_URL = 'http://localhost:5000';
  const FRONTEND_BASE_URL = 'http://localhost:9000';

  document.getElementById('create-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const createButton = document.getElementById('create-button');
    createButton.disabled = true;
    createButton.textContent = 'Creating...';

    const userEmail = document.getElementById('user-email').value;
    const userPassword = document.getElementById('user-password').value;
    const userName = document.getElementById('user-name').value;
    const companyName = document.getElementById('company-name').value;
    const addressLine1 = document.getElementById('address-line1').value;
    const addressCity = document.getElementById('address-city').value;
    const addressRegion = document.getElementById('address-region').value;
    const addressPostalCode = document.getElementById('address-postal-code').value;
    const addressCountryCode = document.getElementById('address-country-code').value;

    const response = await fetch(`${BACKEND_BASE_URL}/v1/external_borrowers`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_KEY}`
      },
      body: JSON.stringify({
        user: { email: userEmail, password: userPassword, name: userName },
        company: { name: companyName },
        address: { city: addressCity, country_code: addressCountryCode, line_1: addressLine1, postal_code: addressPostalCode, region: addressRegion }
      })
    });

    const data = await response.json();
    createButton.disabled = false;
    createButton.textContent = 'Create';

    if (response.status === 201) {
      alert('Borrower and Manager created successfully');
      document.getElementById('step-1').classList.add('hidden');
      document.getElementById('step-2').classList.remove('hidden');
    } else {
      alert(`Error: ${data.message}`);
    }
  });

  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const loginButton = document.getElementById('login-button');
    loginButton.disabled = true;
    loginButton.textContent = 'Logging in...';

    const loginEmail = document.getElementById('login-email').value;
    const loginPassword = document.getElementById('login-password').value;

    const response = await fetch(`${BACKEND_BASE_URL}/v1/external_borrowers/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_KEY}`
      },
      body: JSON.stringify({
        user: { email: loginEmail, password: loginPassword }
      })
    });

    const data = await response.json();
    loginButton.disabled = false;
    loginButton.textContent = 'Login';

    if (response.status === 200) {
      alert('Login successful');
      document.getElementById('step-2').classList.add('hidden');
      document.getElementById('step-3').classList.remove('hidden');
      document.getElementById('onboarding-iframe').src = `${FRONTEND_BASE_URL}/external/onboarding?token=${data.access_token}`;
    } else {
      alert(`Error: ${data.message}`);
    }
  });
</script>
</body>
</html>
